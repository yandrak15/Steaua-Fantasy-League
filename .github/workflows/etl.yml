name: ETL Fantasy

on:
  workflow_dispatch:
    inputs:
      use_selenium:
        description: "Usar Selenium (true/false)"
        required: false
        default: "false"
  push:
    paths:
      - "scripts/**.R"
      - "data/Fantasy.xlsx"
      - ".github/workflows/etl.yml"
      - "main.R"

jobs:
  build-etl:
    runs-on: ubuntu-latest

    env:
      RSPM: https://packagemanager.rstudio.com/cran/__linux__/jammy/latest
      USE_SELENIUM: "true"
      REBUILD_INDEX: "true"
      SCRAPE_MERCADO: "true"   # por defecto NO raspamos en CI (evita Selenium)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3.2"
          use-public-rspm: true

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev

      - name: Install R packages
        run: |
          Rscript -e 'pkgs <- c("data.table","readxl","openxlsx","lubridate","stringr","xml2","rvest","DT","bs4Dash"); inst <- pkgs[!sapply(pkgs, requireNamespace, quietly=TRUE)]; if(length(inst)) install.packages(inst, repos=Sys.getenv("RSPM"));'

      # --- Si algun dÃ­a quieres Selenium en CI, descomenta este bloque y pon SCRAPE_MERCADO=true ---
      - name: Install Selenium (optional)
         if: env.USE_SELENIUM == 'true'
         run: |
           sudo apt-get install -y xvfb default-jre
           Rscript -e 'inst <- c("RSelenium","wdman"); need <- inst[!sapply(inst, requireNamespace, quietly=TRUE)]; if(length(need)) install.packages(need, repos=Sys.getenv("RSPM"));'

      - name: Run ETL
        run: |
          Rscript main.R

      - name: Archive artifact (xlsx)
        uses: actions/upload-artifact@v4
        with:
          name: fantasy_modelo
          path: data/fantasy_modelo.xlsx
          retention-days: 7
